<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>websocket_Test</title>
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
    <meta http-equiv="description" content="This is my page">
</head>
<body onload="web();">
<div>
    <h3>testing...</h3>
    <div id="msgtext">

    </div>
    <div>
        <input type="text" name="msg" id="msg"/>
        <button onclick="sendmsg();">发送</button>
        <br/>
        <input type="file" name="bmsg" id="bmsg"/>
        <button onclick="sendbmsg();">发送</button>
    </div>
</div>

</body>
<script type="text/javascript">
      var ws;
      function web(){
          if('WebSocket' in window){
              ws = new WebSocket("ws://localhost:8080/websocket/web");
          }else{
              alert("不支持 websocket");
          }
          ws.onopen = function(evt){
              //alert("op");
          }
          ws.onclose =function(evt){
              alert("close");
          }
          ws.onmessage = function(evt){
              var msg = evt.data;
              if("[object Blob]" != msg){
                  var msgdiv = document.getElementById("msgtext");
                  var span = document.createElement("span");
                  span.innerHTML = msg+"<br />";
                  msgdiv.appendChild(span);
              }else{
                  var msgdiv = document.getElementById("msgtext");
                  var span = document.createElement("span");
                  var br = document.createElement("br");
                  var can = document.createElement("canvas");
                  var context = can.getContext("2d");
                  var image = new Image();
                    image.onload = function () {
                //image.height
                context.clearRect(0, 0, can.width, can.height);
                context.drawImage(image, 0, 0, can.width, can.height);
            }
            image.src = URL.createObjectURL(msg);
            span.appendChild(can);
            span.appendChild(br);
            msgdiv.appendChild(span);
              }
          }
          ws.onerror = function(evt){
              alert("error");
          }
              }
          function sendmsg(){
              ws.send("游客&nbsp;("+new Date().toLocaleTimeString()+")<br />"+document.getElementById("msg").value);
          }
          function sendbmsg(){
        var inputElement = document.getElementById("bmsg");
        var fileList = inputElement.files;

        for ( var i = 0; i < fileList.length; i++) {
            //发送
            ws.send("游客&nbsp;("+new Date().toLocaleTimeString()+")");
            //读取文件　　
　　　　　        var reader = new FileReader();
            reader.readAsArrayBuffer(fileList[i]);
            //文件读取完毕后该函数响应
            reader.onload = function loaded(evt) {
                var binaryString = evt.target.result;
                ws.send(binaryString);
            }
        }
        return false;
          }


</script>
</html>